# Plan: Interactive Medical Ethics Dilemma Application

**Project Goal:** Create a stateless, Vercel-deployable web application using vanilla HTML, CSS, and JavaScript that presents users with medical ethical dilemmas generated by the Google Gemini API. Users select an option and receive an analysis of their choice.

**Core Technologies:**

*   **Frontend:** HTML, CSS, JavaScript (Vanilla)
*   **API:** Google Gemini API
*   **Backend (for API interaction):** Vercel Serverless Function (Node.js runtime)
*   **Deployment:** Vercel

**Plan:**

1.  **Setup Project Structure:**
    *   Create the necessary files and folders within the `etica-medica/` directory.

    ```
    etica-medica/
    ├── index.html         # Main HTML structure
    ├── style.css          # CSS for styling
    ├── script.js          # Client-side JavaScript logic
    ├── api/               # Vercel serverless functions
    │   └── generateDilemma.js # Function to call Gemini API
    └── vercel.json        # (Optional) Vercel configuration
    └── .env               # Local environment variables (for testing, add to .gitignore)
    └── .gitignore         # To exclude node_modules, .env etc.
    ```

2.  **Develop HTML Structure (`index.html`):**
    *   Basic HTML5 boilerplate.
    *   Link `style.css` and `script.js`.
    *   Main container (`<main>`) for the application content.
    *   Section for the dilemma (`id="dilemma-section"`):
        *   Container for case description (`id="case-description"`).
        *   Container for the ethical question (`id="ethical-question"`).
        *   Container for options (e.g., a `<ul>` or `<form>`, `id="options-container"`).
    *   Section for the analysis (`id="analysis-section"`, initially hidden).
        *   Container for the analysis text (`id="analysis-text"`).
    *   Button to generate a new dilemma (`id="new-dilemma-btn"`).
    *   Loading indicator element (`id="loading-indicator"`, initially hidden).
    *   Footer section for the legal disclaimer (`id="disclaimer"`).

3.  **Implement CSS Styling (`style.css`):**
    *   Apply a clean, professional, and intuitive design.
    *   Use CSS variables for colors/fonts if needed for easier maintenance.
    *   Ensure responsiveness using media queries for different screen sizes (desktop, mobile).
    *   Style the loading indicator (e.g., a spinner or text).
    *   Ensure clear visual separation between dilemma, options, and analysis sections.
    *   Pay attention to accessibility (WCAG 2.1 AA):
        *   Sufficient color contrast.
        *   Logical focus order.
        *   Use of semantic HTML.
        *   ARIA attributes if necessary (though likely minimal with this structure).

4.  **Write Client-Side JavaScript (`script.js`):**
    *   **DOM References:** Get references to all necessary HTML elements (button, containers, loading indicator).
    *   **Event Listeners:**
        *   Click listener on `#new-dilemma-btn` to trigger `fetchDilemma()`.
        *   Event delegation on `#options-container` to handle clicks on generated option elements.
    *   **`fetchDilemma()` Function (async):**
        *   Show `#loading-indicator`, hide `#analysis-section`.
        *   Clear previous dilemma content (description, question, options, analysis).
        *   Make a `fetch` call to our serverless function endpoint (`/api/generateDilemma`).
        *   Handle potential network errors (`try...catch`).
        *   On success:
            *   Parse the JSON response.
            *   Validate the response structure.
            *   Call `displayDilemma()` with the received data.
        *   On failure (network or API error):
            *   Display an informative error message to the user (e.g., in the `#case-description` area).
        *   Hide `#loading-indicator`.
    *   **`displayDilemma(data)` Function:**
        *   Populate `#case-description` with `data.case_description`.
        *   Populate `#ethical-question` with `data.ethical_question`.
        *   Dynamically create list items or radio buttons for each option in `data.options` within `#options-container`. Store the option index or identifier and the corresponding analysis text (from `data.analysis_mapping`) using data attributes (e.g., `data-option-index`, `data-analysis`).
    *   **`handleOptionSelect(event)` Function:**
        *   Check if the clicked element is an option.
        *   Retrieve the analysis text from the selected option's data attribute.
        *   Populate `#analysis-text` with the retrieved analysis.
        *   Show `#analysis-section`.
        *   (Optional) Visually highlight the selected option.
    *   **Initial Load:** Optionally call `fetchDilemma()` when the page loads.
    *   **Disclaimer:** Ensure the disclaimer text ("This tool is for educational purposes only. AI-generated content may not be fully accurate or reflect definitive ethical judgments. It does not substitute professional medical or ethical advice.") is present in the HTML or added via JS.

5.  **Create Serverless Function (`api/generateDilemma.js`):**
    *   Use Node.js runtime.
    *   Import necessary libraries (e.g., Google Generative AI SDK `@google/generative-ai`).
    *   Define an `async` handler function (standard Vercel format `export default async function handler(req, res) { ... }`).
    *   **Security:** Retrieve the `GEMINI_API_KEY` from `process.env`. **Never hardcode the key.**
    *   Instantiate the Gemini client using the API key.
    *   Define the prompt: "Generate a medical ethical dilemma with description, question, options, and analysis mapping. Ensure the output is a valid JSON object with keys: 'case_description' (string), 'ethical_question' (string), 'options' (array of strings, 3-5 items), and 'analysis_mapping' (object where keys are option indices 0, 1, 2... and values are analysis strings)."
    *   Call the Gemini API (`generateContent` method) with the prompt.
    *   **Response Handling:**
        *   Extract the text response from Gemini.
        *   Attempt to `JSON.parse()` the text response.
        *   **Crucial:** Validate the parsed object structure to ensure it contains the required keys (`case_description`, `ethical_question`, `options`, `analysis_mapping`) and that `options` is an array and `analysis_mapping` is an object. If validation fails, return a 500 error.
        *   If successful and valid, send a 200 status with the parsed JSON object as the response body (`res.status(200).json(parsedData)`).
    *   **Error Handling:** Implement `try...catch` around the API call and parsing. If any error occurs (API error, parsing error, validation error), send an appropriate error status (e.g., 500) and a JSON error message (`res.status(500).json({ error: 'Failed to generate dilemma.' })`).

6.  **Deployment & Configuration (Vercel):**
    *   Connect the GitHub repository (containing the `etica-medica/` code) to Vercel.
    *   Configure the build settings (usually auto-detected for static sites + API folder).
    *   Add the `GEMINI_API_KEY` as an Environment Variable in the Vercel project settings.
    *   Deploy.

**User Flow & Interaction Diagram (Mermaid):**

```mermaid
sequenceDiagram
    participant User
    participant Browser (HTML/CSS/JS)
    participant Vercel Function (/api/generateDilemma)
    participant Google Gemini API

    User->>Browser (HTML/CSS/JS): Clicks "Generate New Dilemma"
    Browser (HTML/CSS/JS)->>Browser (HTML/CSS/JS): Show Loading Indicator
    Browser (HTML/CSS/JS)->>Vercel Function (/api/generateDilemma): fetch('/api/generateDilemma')
    Vercel Function (/api/generateDilemma)->>Vercel Function (/api/generateDilemma): Get API Key from Env Vars
    Vercel Function (/api/generateDilemma)->>Google Gemini API: Generate Content Request (Prompt)
    Google Gemini API-->>Vercel Function (/api/generateDilemma): Raw Text Response (JSON expected)
    Vercel Function (/api/generateDilemma)->>Vercel Function (/api/generateDilemma): Parse & Validate JSON
    alt Valid JSON
        Vercel Function (/api/generateDilemma)-->>Browser (HTML/CSS/JS): 200 OK with Dilemma JSON
        Browser (HTML/CSS/JS)->>Browser (HTML/CSS/JS): Hide Loading Indicator
        Browser (HTML/CSS/JS)->>Browser (HTML/CSS/JS): Update UI (Case, Question, Options)
        Browser (HTML/CSS/JS)->>User: Display Dilemma & Options
    else Invalid JSON or API Error
        Vercel Function (/api/generateDilemma)-->>Browser (HTML/CSS/JS): 500 Server Error
        Browser (HTML/CSS/JS)->>Browser (HTML/CSS/JS): Hide Loading Indicator
        Browser (HTML/CSS/JS)->>User: Display Error Message
    end

    User->>Browser (HTML/CSS/JS): Selects an Option
    Browser (HTML/CSS/JS)->>Browser (HTML/CSS/JS): Get Analysis from data attribute
    Browser (HTML/CSS/JS)->>Browser (HTML/CSS/JS): Display Analysis Text
    Browser (HTML/CSS/JS)->>User: Show Analysis for Selected Option